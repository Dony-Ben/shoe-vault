<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Orders</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
        }
        .status-pending { background-color: #ffc107; color: #000; }
        .status-processing { background-color: #17a2b8; color: #fff; }
        .status-shipped { background-color: #007bff; color: #fff; }
        .status-completed { background-color: #28a745; color: #fff; }
        .status-cancelled { background-color: #dc3545; color: #fff; }
    </style>
</head>
<%- include('../partials/user/profile.ejs') %>

<body>
    <div class="fixed top-0 left-0 w-full z-50 bg-white shadow-md">
        <%- include('../partials/user/header.ejs') %>
    </div>
    <div class="container mt-4">
      <h1 class="mb-4 text-center"></h1>
      <% if (orders && orders.length > 0) { %>
        <% orders.forEach(order => { %>
            <div class="d-flex justify-content-center">
              <div class="card mt-3" style="width: 24rem;">
                <div class="card-body">
                    <h5 class="card-title">Order #<%= order._id %></h5>
                    <p>Status: 
                      <span class="status-badge status-<%= order.orderStatus.toLowerCase() %>">
                        <%= order.orderStatus %>
                      </span>
                    </p>
                    <p>Order Date: <%= new Date(order.orderDate).toLocaleDateString() %></p>
                    <p>Total: $<%= order.finalAmount.toFixed(2) %></p>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#orderModal<%= order._id %>">
                      View Details
                    </button>
                    <% if (order.orderStatus === 'Pending') { %>
                      <form action="/orders/<%= order._id %>/cancel" method="POST" class="d-inline">
                        <button type="submit" class="btn btn-danger">Cancel Order</button>
                      </form>
                    <% } %>
                </div>
              </div>
            </div>
            <!-- Order Details Modal -->
            <div class="modal fade" id="orderModal<%= order._id %>" tabindex="-1" aria-labelledby="orderModalLabel<%= order._id %>" aria-hidden="true">
              <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="orderModalLabel<%= order._id %>">Order Details</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <p><strong>Status:</strong> <%= order.orderStatus %></p>
                      <p><strong>Order Date:</strong> <%= new Date(order.orderDate).toLocaleDateString() %></p>
                      <p><strong>Payment Method:</strong> <%= order.paymentMethod %></p>
                      <p><strong>Total Price:</strong> $<%= order.finalAmount.toFixed(2) %></p>
                      <% if (order.items && order.items.length > 0) { %>
                        <div class="table-responsive">
                            <table class="table table-striped">
                              <thead>
                                <tr>
                                    <th>Image</th>
                                    <th>Product</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                </tr>
                              </thead>
                              <tbody>
                                <% order.items.forEach(item => { %>
                                    <tr>
                                      <td>
                                        <img src="/uploads/re-image/<%= item.productImage %>" alt="<%= item.productName %>" class="img-thumbnail" style="max-width: 50px;">
                                      </td>
                                      <td><%= item.productName %></td>
                                      <td><%= item.quantity %></td>
                                      <td>$<%= item.price.toFixed(2) %></td>
                                    </tr>
                                <% }); %>
                              </tbody>
                            </table>
                        </div>
                      <% } else { %>
                        <p>No items found for this order.</p>
                      <% } %>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
              </div>
            </div>
        <% }); %>
      <% } else { %>
        <p class="text-center">No orders found.</p>
      <% } %>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
                    <script>
                        document.querySelectorAll('form[action*="/cancel"]').forEach(form => {
                            form.addEventListener('submit', function(event) {
                                event.preventDefault();
                                Swal.fire({
                                    title: 'Are you sure?',
                                    text: "want to cancel this product !",
                                    icon: 'warning',
                                    showCancelButton: true,
                                    confirmButtonColor: '#3085d6',
                                    cancelButtonColor: '#d33',
                                    confirmButtonText: 'Yes, cancel it!',
                                    customClass: {
                                        popup: 'small-swal-popup'
                                    }
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        form.submit();
                                    }
                                });
                            });
                        });
                    </script>
                    <style>
                        .small-swal-popup {
                            width: 300px !important;
                        }
                    </style>
</body>
</html>