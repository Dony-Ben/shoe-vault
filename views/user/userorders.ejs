<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Orders</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .status-badge {
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.8em;
    }

    .status-pending {
      background-color: #ffc107;
      color: #000;
    }

    .status-processing {
      background-color: #17a2b8;
      color: #fff;
    }

    .status-shipped {
      background-color: #007bff;
      color: #fff;
    }

    .status-completed {
      background-color: #28a745;
      color: #fff;
    }

    .status-cancelled {
      background-color: #dc3545;
      color: #fff;
    }
  </style>
</head>
<%- include('../partials/user/profile.ejs') %>

  <body>
    <div class="fixed top-0 left-0 w-full z-50 bg-white shadow-md">
    </div>
    <div class="container mt-6" style="margin-top: 5rem;">
      <h1 class="mb-4 text-center"></h1>
      <% if (orders && orders.length> 0) { %>
        <% orders.forEach(order=> { %>
          <div class="container mb-4">
            <div class="card shadow-sm p-3">
              <h5 class="mb-3">Order #<%= order._id %>
              </h5>
              <p>Status:
                <span class="status-badge status-<%= order.orderStatus.toLowerCase() %>">
                  <%= order.orderStatus %>
                </span>
              </p>
              <p>Order Date: <%= new Date(order.orderDate).toLocaleDateString() %>
              </p>
              <p>Payment Method: <%= order.paymentMethod %>
              </p>
              <p>Total: $<%= order.finalAmount?.toFixed(2) || "0.00" %>
              </p>

              <% if (order.items && order.items.length> 0) { %>
                <div class="table-responsive mt-3">
                  <table class="table table-bordered">
                    <thead>
                      <tr>
                        <th>Image</th>
                        <th>Product</th>
                        <th>Quantity</th>
                        <th>Price</th>
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% order.items.forEach(item=> { %>
                        <tr>
                          <td>
                            <img src="<%= item.productImage %>" alt="<%= item.productName %>" class="img-thumbnail"
                              style="max-width: 50px;">
                          </td>
                          <td>
                            <%= item.productName %>
                          </td>
                          <td>
                            <%= item.quantity %>
                          </td>
                          <td>$<%= item.price.toFixed(2) %>
                          </td>
                          <td>
                            <% if (!item.cancelled && order.orderStatus==='Pending' ) { %>
                              <form method="POST"
                                action="/orders/<%= order._id %>/cancel-item/<%= item.productId._id %>">
                                <button class="btn btn-sm btn-danger">Cancel</button>
                              </form>
                              <% } else { %>
                                <span class="badge bg-secondary">Cancelled</span>
                                <% } %>
                          </td>
                        </tr>
                        <% }); %>
                    </tbody>
                  </table>
                </div>
                <% } else { %>
                  <p>No items found in this order.</p>
                  <% } %>
            </div>
          </div>
          <% }); %>
            <% } else { %>
              <p class="text-center">No orders found.</p>
              <% } %>
                <div class="pagination d-flex justify-content-center">
                  <% for (let i=1; i <=totalPages; i++) { %>
                    <a href="?page=<%= i %>"
                      class="px-3 py-2 mx-1 text-decoration-none <%= currentPage === i ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700' %> rounded-md hover:bg-blue-600 hover:text-white transition duration-200">
                      <%= i %>
                    </a>
                    <% } %>
                </div>
                <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
                <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
                <script>
                  document.querySelectorAll('.cancel-item-form').forEach(form => {
                    form.addEventListener('submit', function (event) {
                      event.preventDefault();
                      Swal.fire({
                        title: 'Cancel this item?',
                        text: "This action cannot be undone.",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#aaa',
                        confirmButtonText: 'Yes, cancel it'
                      }).then((result) => {
                        if (result.isConfirmed) {
                          form.submit();
                        }
                      });
                    });
                  });
                </script>
                <style>
                  .small-swal-popup {
                    width: 300px !important;
                  }
                </style>
  </body>

</html>