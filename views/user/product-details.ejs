<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>
    <%= productData.productName %> - Product Detail
  </title>
  <link rel="stylesheet" type="text/css" href="bootstrap.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="responsive.css">
  <link rel="stylesheet" href="jquery.mCustomScrollbar.min.css">
  <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/font-awesome/4.0.3/font-awesome.css">
  <link rel="stylesheet" href="owl.carousel.min.css">
 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.min.css" 
    media="screen"> 
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    .product-image-slider img {
      width: 100%;
      height: 400px;
      object-fit: cover;
      border-radius: 10px;

    }

    .slider-nav-thumbnails img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .slider-nav-thumbnails img:hover {
      transform: scale(1.1);
    }

    .related-products .card {
      transition: all 0.3s ease;
    }

    .related-products .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }

    /*  */
    .image-zoom-container {
      position: relative;
      width: 100%;
      height: 400px;
      overflow: hidden;
    }

    #mainImage {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 10px;
    }

    #zoomLens {
      position: absolute;
      border: 2px solid #ccc;
      width: 100px;
      height: 100px;
      background: rgba(255, 255, 255, 0.4);
      pointer-events: none;
      display: none;
    }

    .product-image-slider {
      position: relative;
      cursor: crosshair;
    }
  </style>
</head>

<body>
  <div class="fixed top-0 left-0 w-full z-50 bg-white shadow-md">
    <%- include('../partials/user/header.ejs') %>
  </div>
  <main class="main">
    <section class="mt-5 mb-5">
      <div class="container">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb bg-light p-3 rounded">
            <li class="breadcrumb-item"><a href="/home" class="text-decoration-none">Home</a></li>
            <li class="breadcrumb-item"><a href="/shop" class="text-decoration-none">Shop</a></li>
            <li class="breadcrumb-item active" aria-current="page">
              <%= productData.productName %>
            </li>
          </ol>
        </nav>

        <div class="row">
          <div class="col-lg-6">
            <div class="product-image-slider mb-4 position-relative">
              <!-- Main Image -->
              <div id="mainImageContainer" class="image-zoom-container">
                <img id="mainImage" src="/uploads/re-image/<%= productData.productImage[0] %>"
                  alt="<%= productData.productName %> - Main Image" class="img-fluid">
                <div id="zoomLens" class="zoom-lens"></div>
              </div>
            </div>
            <div class="slider-nav-thumbnails d-flex justify-content-center">
              <% productData.productImage.forEach((image, index)=> { %>
                <div class="mx-2">
                  <img src="/uploads/re-image/<%= image %>" alt="Thumbnail <%= index + 1 %>" class="thumbnail"
                    onclick="changeMainImage('<%= image %>')" style="cursor: pointer; width: 80px; height: 80px;">
                </div>
                <% }); %>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="product-details">
                <h1 class="mb-4" style="color: black; font-weight: bold; font-size: 28px;">
                  <%= productData.productName %>
                </h1>
              <div class="d-flex justify-content-between align-items-center mb-4">
                <div class="product-price">
                  <span class="h3 text-success">â‚¹<%= productData.salePrice.toFixed(2) %></span>
                </div>
                <div class="product-rating">
                  <% for (let i=0; i < 5; i++) { %>
                    <i class="fas fa-star <%= i < productData.rating ? 'text-warning' : 'text-muted' %>"></i>
                    <% } %>
                      <span class="ms-2 text-muted">(25 reviews)</span>
                </div>
              </div>
              <p class="mb-4">
                <%= productData.description %>
              </p>
              <div class="mb-4">
                <h5>Key Features:</h5>
              </div>
              <% if(productData.quantity>0) { %>
                <div class="d-flex align-items-center mb-4">     
                  <a onclick="addToCart(event, `<%= productData._id %>`)"
                    class="modern-btn btn btn-black bg-black hover:bg-opacity-80 text-light transition duration-300 add-to-cart-btn"
                    data-product-id="<%= productData._id %>">
                    Add to Cart
                  </a>
                </div>
              <%}else{%>
                <div class="d-flex align-items-center mb-4">
                  <button class="btn btn-black bg-black hover:bg-opacity-80 text-light transition duration-300 add-to-cart-btn"
                    disabled>
                    Out of Stock
                  </button>
                </div>
             <% } %>
              
              <div id="toast"
                style="position: fixed; bottom: 20px; right: 20px; background: #043703; color: #ffffff; padding: 10px 15px; border-radius: 5px; display: none; z-index: 1000;">
              </div>

              <div class="mb-4">
                <h5>Stock:
                  <sp an class="<%= productData.status ? 'text-success' : 'text-danger' %>">
                    <%= productData.status ? productData.quantity : 'Out of Stock' %>
                  </span>
                </h5>
              </div>
            </div>
          </div>
        </div>

        <!-- Related Products Section -->
        <div class="related-products mt-5">
          <h2 class="mb-4">Related Products</h2>
          <div class="row">
            <div class="col-md-3 mb-4">
              <div class="card h-100">
                <img src="/uploads/re-image<%= productData.productImage[0] %>" class="card-img-top"
                  alt="<%= productData.productName %>">
                <div class="card-body">
                  <h5 class="card-title">
                    <%= productData.productName %>
                  </h5>
                  <p class="card-text">$<%= productData.salePrice.toFixed(2) %>
                  </p>
                  <a href="/product/<%= productData.id %>" class="btn btn-outline-primary">View Details</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const eventSource = new EventSource('/events');
    eventSource.onmessage = (event) => {
      if (event.data === 'StockUpdated') {
      console.log('Stock updated, refreshing...');
      window.location.reload();
      }
    };


    function changeMainImage(thumbnail, index) {
      const mainImages = document.querySelectorAll('.product-image-slider > div');
      mainImages.forEach(img => img.classList.remove('active'));
      mainImages[index].classList.add('active');
    }

    // function updateQuantity(change) {
    //   const quantityInput = document.getElementById('quantity');
    //   let newQuantity = parseInt(quantityInput.value) + change;
    //   if (newQuantity < 1) newQuantity = 1;
    //   quantityInput.value = newQuantity;
    // }

    function changeMainImage(imageSrc) {
      const mainImage = document.getElementById('mainImage');
      mainImage.src = `/uploads/product-images/${imageSrc}`;
    }

    const mainImage = document.getElementById('mainImage');
    const zoomLens = document.getElementById('zoomLens');
    const mainImageContainer = document.getElementById('mainImageContainer');

    mainImageContainer.addEventListener('mousemove', (e) => {
      const rect = mainImage.getBoundingClientRect();
      const x = e.clientX - rect.left; // x-coordinate inside the image
      const y = e.clientY - rect.top; // y-coordinate inside the image

      const lensWidth = zoomLens.offsetWidth / 2;
      const lensHeight = zoomLens.offsetHeight / 2;

      let lensX = x - lensWidth;
      let lensY = y - lensHeight;

      // Constrain the lens within the image boundaries
      lensX = Math.max(0, Math.min(lensX, rect.width - zoomLens.offsetWidth));
      lensY = Math.max(0, Math.min(lensY, rect.height - zoomLens.offsetHeight));

      zoomLens.style.left = lensX + 'px';
      zoomLens.style.top = lensY + 'px';
      zoomLens.style.display = 'block';
      zoomLens.style.backgroundPosition = `-${lensX * 2}px -${lensY * 2}px`;

      // Set the zoomed background
      zoomLens.style.backgroundImage = `url(${mainImage.src})`;
      zoomLens.style.backgroundSize = `${rect.width * 2}px ${rect.height * 2}px`;
    });

    mainImageContainer.addEventListener('mouseleave', () => {
      zoomLens.style.display = 'none';
    });

    // Simple Toast Function
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.style.display = 'block';

      // Hide after 3 seconds
      setTimeout(() => {
        toast.style.display = 'none';
      }, 3000);
    }
  </script>
  <%- include('../partials/user/footer.ejs') %>
</body>

</html>