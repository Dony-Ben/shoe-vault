<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Address</title>
    <link rel="stylesheet" href="/stylesheets/style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
   body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    background-color: #f8f8f8;
    overflow: hidden; /* Prevents horizontal scrollbar */
}

.address-card {
    border: 1px solid #ff0000;
    border-radius: 10px;
    padding: 20px;
    margin: 10px;
    box-shadow: 0 4px 6px rgba(34, 179, 5, 0.1);
    transition: transform 0.2s;
    background: white;
    position: absolute;
    animation: moveLeftToRight 3s linear infinite alternate; /* Animation */
}

.address-card:hover {
    transform: scale(1.02);
}

.add-address-btn {
    margin-bottom: 20px;
}

    </style>

</head>
<%- include('../partials/user/profile.ejs') %>
<%- include('../partials/user/header.ejs') %>
    <body>
 
        <div class="container mt-4">
            <h2 class="text-center mb-4">Manage Your Addresses</h2>

            <!-- Add Address Button -->
            <button class="btn btn-primary add-address-btn" data-bs-toggle="modal" data-bs-target="#addAddressModal">
                <i class="bi bi-plus-circle"></i> Add New Address
            </button>

            <!-- Add Address Modal -->
            <div class="modal fade" id="addAddressModal" tabindex="-1" aria-labelledby="addAddressModalLabel"
                aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="addAddressModalLabel">Add New Address</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <form action="/add-address" method="POST">
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="addressType" class="form-label">Address Type</label>
                                    <select class="form-select" id="addressType" name="addressType" >
                                        <option value="" disabled selected>Select Address Type</option>
                                        <option value="Home">Home</option>
                                        <option value="Work">Work</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="name" class="form-label">Name</label>
                                    <input type="text" class="form-control" id="name" name="name" >
                                </div>
                                <div class="mb-3">
                                    <label for="phone" class="form-label">Phone</label>
                                    <input type="text" class="form-control" id="phone" name="phone" >
                                </div>
                                <div class="mb-3">
                                    <label for="city" class="form-label">City</label>
                                    <input type="text" class="form-control" id="city" name="city" >
                                </div>
                                <div class="mb-3">
                                    <label for="state" class="form-label">State</label>
                                    <input type="text" class="form-control" id="state" name="state" >
                                </div>
                                <div class="mb-3">
                                    <label for="pincode" class="form-label">Pincode</label>
                                    <input type="text" class="form-control" id="pincode" name="pincode" >
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="submit" class="btn btn-primary">Save Address</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <!-- Edit Address Modal -->
            <div class="modal fade" id="editAddressModal" tabindex="-1" aria-labelledby="editAddressModalLabel"
                aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="editAddressModalLabel">Edit Address</h5>
                        </div>
                        <form id="editAddressForm" method="POST">
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="editAddressType" class="form-label">Address Type</label>
                                    <select class="form-select" id="editAddressType" name="addressType" >
                                        <option value="Home">Home</option>
                                        <option value="Work">Work</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="editName" class="form-label">Name</label>
                                    <input type="text" class="form-control" id="editName" name="name" >
                                </div>
                                <div class="mb-3">
                                    <label for="editPhone" class="form-label">Phone</label>
                                    <input type="text" class="form-control" id="editPhone" name="phone" >
                                </div>
                                <div class="mb-3">
                                    <label for="editCity" class="form-label">City</label>
                                    <input type="text" class="form-control" id="editCity" name="city" >
                                </div>
                                <div class="mb-3">
                                    <label for="editState" class="form-label">State</label>
                                    <input type="text" class="form-control" id="editState" name="state" >
                                </div>
                                <div class="mb-3">
                                    <label for="editPincode" class="form-label">Pincode</label>
                                    <input type="text" class="form-control" id="editPincode" name="pincode" >
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Address List -->   
            <div class="row">
                <% address.forEach((address)=> { %>
                    <div class="col-md-4">
                        <div class="address-card">
                            <p><strong>Name:</strong>
                                <%= address.name %>
                            </p>
                            <p><strong>Phone:</strong>
                                <%= address.phone %>
                            </p>
                            <p><strong>Address:</strong>
                                <%= address.city %>, <%= address.state %>, <%= address.pincode %>
                            </p>
                            <div class="d-flex justify-content-between">
                                <button class="btn btn-success btn-sm"
                                    onclick="openEditModal('<%= address._id %>')">Edit</button>
                                <form action="/user/delete-address/<%= address._id %>" method="POST"
                                    style="display:inline;">
                                    <button class="btn btn-danger btn-sm">
                                        Delete
                                    </button>
                                </form>



                            </div>
                        </div>
                    </div>
                    <% }) %>
            </div>

        </div>

        <script>
            function openEditModal(addressId) {
                const modal = new bootstrap.Modal(document.getElementById('editAddressModal'));
                modal.show();

                console.log("openEditModal triggered with ID:", addressId);

                // Fetch the existing address details
                fetch(`/edit-address/${addressId}`)
                    .then((response) => {
                        if (!response.ok) {
                            throw new Error('Failed to fetch address');
                        }
                        return response.json();
                    })
                    .then((address) => {
                        // Populate modal fields with address data
                        document.getElementById('editAddressType').value = address.addressType || "Home";
                        document.getElementById('editName').value = address.name;
                        document.getElementById('editPhone').value = address.phone;
                        document.getElementById('editCity').value = address.city;
                        document.getElementById('editState').value = address.state;
                        document.getElementById('editPincode').value = address.pincode;

                        // Update form action
                        document.getElementById('editAddressForm').action = `/edit-address/${address._id}`;
                    })
                    .catch((error) => {
                        console.error('Error fetching address details:', error);
                        alert('Failed to load address details. Please try again.');
                    });
            }

            // Delete Address Confirmation

            document.querySelectorAll('form[action^="/user/delete-address"]').forEach(form => {
                form.addEventListener('submit', function (event) {
                    event.preventDefault();
                    Swal.fire({
                        title: 'Are you sure?',
                        text: "want to delete this address!",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Yes'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            form.submit();
                        }
                    });
                });
            });
        </script>
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const addAddressForm = document.querySelector('form[action="/add-address"]');
                const editAddressForm = document.getElementById('editAddressForm');

                function validateForm(form) {
                    let isValid = true;
                    const fields = ['name', 'phone', 'city', 'state', 'pincode'];
                    fields.forEach(field => {
                        const input = form.querySelector(`input[name="${field}"]`);
                        if (!input.value.trim()) {
                            input.classList.add('is-invalid');
                            input.nextElementSibling.textContent = `${field.charAt(0).toUpperCase() + field.slice(1)} is required`;
                            isValid = false;
                        } else {
                            input.classList.remove('is-invalid');
                            input.nextElementSibling.textContent = '';
                        }
                    });

                    const phone = form.querySelector('input[name="phone"]').value.trim();
                    const phonePattern = /^[0-9]{10}$/;
                    if (!phonePattern.test(phone)) {
                        const phoneInput = form.querySelector('input[name="phone"]');
                        phoneInput.classList.add('is-invalid');
                        phoneInput.nextElementSibling.textContent = 'Phone number must be 10 digits';
                        isValid = false;
                    }

                    const pincode = form.querySelector('input[name="pincode"]').value.trim();
                    const pincodePattern = /^[0-9]{6}$/;
                    if (!pincodePattern.test(pincode)) {
                        const pincodeInput = form.querySelector('input[name="pincode"]');
                        pincodeInput.classList.add('is-invalid');
                        pincodeInput.nextElementSibling.textContent = 'Pincode must be 6 digits';
                        isValid = false;
                    }

                    return isValid;
                }

                addAddressForm.addEventListener('submit', function (event) {
                    if (!validateForm(addAddressForm)) {
                        event.preventDefault();
                    }
                });

                editAddressForm.addEventListener('submit', function (event) {
                    if (!validateForm(editAddressForm)) {
                        event.preventDefault();
                    }
                });
            });
        </script>

    </body>

</html>