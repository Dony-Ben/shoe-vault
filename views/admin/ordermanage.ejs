<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
        }

        .status-pending {
            background-color: #ffc107;
            color: #000;
        }

        .status-processing {
            background-color: #17a2b8;
            color: #fff;
        }

        .status-shipped {
            background-color: #007bff;
            color: #fff;
        }

        .status-completed {
            background-color: #28a745;
            color: #fff;
        }

        .status-cancelled {
            background-color: #dc3545;
            color: #fff;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #28a745;
            color: white;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
    </style>
</head>
<%- include('../partials/admin/leyout.ejs') %>

    <body>
        <div class="container mt-4">
            <!-- Admin Order Management -->
            <h1 class="mb-4">Order Management</h1>
            <div class="orders-table">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Date</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% orders.forEach(order=> { %>
                            <tr>
                                <td>#<%= order._id %>
                                </td>
                                <td>
                                    <%= order.userId.name %>
                                </td>
                                <td>
                                    <%= new Date(order.orderDate).toLocaleDateString() %>
                                </td>
                                <td>$<%= order.finalAmount.toFixed(2) %>
                                </td>
                                <td>
                                    <span class="status-badge status-<%= order.orderStatus.toLowerCase() %>">
                                        <%= order.orderStatus %>
                                    </span>
                                </td>
                                <td>
                                    <select class="form-select status-select" id="status-<%= order._id %>">
                                        <option value="Pending" <%=order.orderStatus==='Pending' ? 'selected' : '' %>
                                            >Pending</option>
                                        <option value="Processing" <%=order.orderStatus==='Processing' ? 'selected' : ''
                                            %>
                                            >Processing</option>
                                        <option value="Shipped" <%=order.orderStatus==='Shipped' ? 'selected' : '' %>
                                            >Shipped</option>
                                        <option value="Completed" <%=order.orderStatus==='Completed' ? 'selected' : ''
                                            %>
                                            >Completed</option>
                                        <option value="Cancelled" <%=order.orderStatus==='Cancelled' ? 'selected' : ''
                                            %>
                                            >Cancelled</option>
                                    </select>
                                    <button class="btn btn-primary btn-sm mt-2 update-status-btn"
                                        onclick="updateStatus('<%= order._id %>')">Update</button>
                                </td>
                            </tr>
                            <% }); %>
                    </tbody>
                </table>
            </div>

        </div>

        <div id="toast" class="toast">Status updated successfully!</div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            function updateStatus(orderId) {
                const select = document.getElementById(`status-${orderId}`);
                const newStatus = select.value;

                console.log('Order ID:', orderId);
                console.log('New Status:', newStatus);


                fetch('/admin/orders/update-status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ orderId, orderStatus: newStatus }),
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Response data:', data); // Debugging

                        if (data.success) {
                            // Update the status badge without refreshing the page
                            const statusBadge = document.querySelector(`#status-${orderId}`).closest('tr').querySelector('.status-badge');
                            statusBadge.textContent = newStatus;
                            statusBadge.className = `status-badge status-${newStatus.toLowerCase()}`;

                            Array.from(select.options).forEach(option => {
                                if (option.value === newStatus || option.index < select.selectedIndex) {
                                    option.disabled = true;
                                }
                            });
                            // Optional: Show a toast notification for feedback
                            const toast = document.getElementById('toast');
                            toast.textContent = 'Order status updated successfully!';
                            toast.style.display = 'block';
                            setTimeout(() => {
                                toast.style.display = 'none';
                            }, 3000);
                        } else {
                            alert('Failed to update order status. Please try again.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while updating the order status.');
                    });
            }

        </script>
    </body>

</html>